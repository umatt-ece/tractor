#include <stdbool.h>
#include <stdio.h>

#include "S32K344.h"
#include "heart.h"
#include "interlock_sm.h"

// Page 41 describes the mapping between the Port groups to the index
// for example PTD31 is 127 -> PortD[0-31] = MSCR127
#define PTD31 127
#define PTD15 111

typedef void(*Task)(void);

void blinkyTask() {
	// True xor True = false and False xor True = True
	SIUL2.GPDO111.B.PDO_N ^= true;
}

void blinkyInit() {
	// Configures the Lowside Digital output as required by the Audesse Flexcase G
	SIUL2.MSCR[PTD31].B.OBE = true;
	SIUL2.GPDO127.B.PDO_N = true;

	SIUL2.MSCR[PTD15].B.OBE = true;
	SIUL2.GPDO111.B.PDO_N = false;
}

int main(void) {
#define NEXT_TASK_MS 500UL
#define NUM_TASKS 1
	Task tasks[NUM_TASKS] = {blinkyTask};
	uint8_t currentTask = 0;

	uint32_t msCount = 0;

	// Enable our SysTicks to have 1 ms timing
	heartInit();

	blinkyInit();

	// Turn on our interrupt handler for NVIC
	__enable_irq();

	while(1) {
		// Sleep until we have an interrupt
		__WFI();

		msCount = elapsedMs();


		if((msCount % NEXT_TASK_MS) == 0) {
			tasks[currentTask]();

			currentTask = (currentTask + 1) % NUM_TASKS;
		}
	}
}


